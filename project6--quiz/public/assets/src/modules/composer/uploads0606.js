"use strict";define("composer/uploads",["composer/preview","composer/categoryList","translator","jquery-form"],function(e,r,t){var a={inProgress:{}};var i="";a.initialize=function(e){u(e);f(e);o(e);n(e);t.translate("[[modules:composer.uploading, "+0+"%]]",function(e){i=e})};function o(e){var r=$('.composer[data-uuid="'+e+'"]');r.find("#files").on("change",function(r){var t=(r.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);if(t){d({files:t,post_uuid:e,route:"/api/post/upload"})}})}function n(e){var r=$('.composer[data-uuid="'+e+'"]');r.on("click",".topic-thumb-clear-btn",function(e){r.find("input#topic-thumb-url").val("").trigger("change");s(r.find("input#topic-thumb-file"));$(this).addClass("hide");e.preventDefault()});r.on("paste change keypress","input#topic-thumb-url",function(){var e=$(this);setTimeout(function(){var t=e.val();if(t){r.find(".topic-thumb-clear-btn").removeClass("hide")}else{s(r.find("input#topic-thumb-file"));r.find(".topic-thumb-clear-btn").addClass("hide")}r.find("img.topic-thumb-preview").attr("src",t)},100)})}function s(e){e.wrap("<form />").closest("form").get(0).reset();e.unwrap()}function u(e){var r=false;var t=$('.composer[data-uuid="'+e+'"]');var a=t.find(".imagedrop");function i(){if(r){return}a.css("top","0px");a.css("height",t.height()+"px");a.css("line-height",t.height()+"px");a.show();a.on("dragleave",function(){a.hide();a.off("dragleave")})}function o(r){r.preventDefault();var t=r.originalEvent.dataTransfer.files;var i;if(t.length){if(window.FormData){i=new FormData;for(var o=0;o<t.length;++o){i.append("files[]",t[o],t[o].name)}}d({files:t,post_uuid:e,route:"/api/post/upload",formData:i})}a.hide();return false}function n(e){e.preventDefault();return false}$(document).off("dragstart").on("dragstart",function(){r=true}).off("dragend").on("dragend",function(){r=false});t.on("dragenter",i);a.on("dragover",n);a.on("dragenter",n);a.on("drop",o)}function f(e){var r=$('.composer[data-uuid="'+e+'"]');r.on("paste",function(r){var t=(r.clipboardData||r.originalEvent.clipboardData||{}).items;[].some.call(t,function(r){var t=r.getAsFile();if(!t){return false}var a=utils.generateUUID()+"-"+t.name;var i=null;if(window.FormData){i=new FormData;i.append("files[]",t,a)}d({files:[t],fileNames:[a],post_uuid:e,route:"/api/post/upload",formData:i});return true})})}function p(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function l(e,r,t){return e.slice(0,r)+t+e.slice(r)}function d(o){var n=[...o.files];var s=o.post_uuid;var u=$('.composer[data-uuid="'+s+'"]');var f=u.find("textarea");var d=f.val();var m=u.find("#fileForm");var g=false;m.attr("action",config.relative_path+o.route);var v=r.getSelectedCid();if(!v&&ajaxify.data.cid){v=ajaxify.data.cid}var h=0;var b=false;for(h=0;h<n.length;++h){b=n[h].type.match(/image./);if(b&&!app.user.privileges["upload:post:image"]||!b&&!app.user.privileges["upload:post:file"]){return app.alertError("[[error:no-privileges]]")}}var w=[];for(h=0;h<n.length;++h){w.push(h+"_"+Date.now()+"_"+(o.fileNames?o.fileNames[h]:n[h].name));b=n[h].type.match(/image./);if(n[h].size>parseInt(config.maximumFileSize,10)*1024){m[0].reset();return app.alertError("[[error:file-too-big, "+config.maximumFileSize+"]]")}d=l(d,f.getCursorPosition(),(b?"!":"")+"["+w[h]+"]("+i+") ")}if(m.length){u.find('[data-action="post"]').prop("disabled",true)}f.val(d);$(window).trigger("action:composer.uploadStart",{post_uuid:s,files:w.map(function(e,r){return{filename:e.replace(/^\d+_\d{13}_/,""),isImage:/image./.test(n[r].type)}}),text:i});m.off("submit").submit(function(){function r(e,r,t){var a;if(t){a=e.replace(/^\d+_\d{13}_/,"")}var i=f.val();var o=new RegExp(p(e)+"]\\([^)]+\\)","g");f.val(i.replace(o,(a||e)+"]("+r+")"));$(window).trigger("action:composer.uploadUpdate",{post_uuid:s,filename:e,text:r})}a.inProgress[s]=a.inProgress[s]||[];a.inProgress[s].push(1);if(o.formData){o.formData.append("cid",v)}$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:true,clearForm:true,formData:o.formData,data:{cid:v},error:function(t){g=true;u.find('[data-action="post"]').prop("disabled",false);const a=c(t,s);for(var i=0;i<n.length;++i){r(w[i],a,true)}e.render(u)},uploadProgress:function(e,a,i,o){t.translate("[[modules:composer.uploading, "+o+"%]]",function(e){if(g){return}for(var t=0;t<n.length;++t){r(w[t],e)}})},success:function(t){const a=t.response.images;g=true;if(a&&a.length){for(var i=0;i<a.length;++i){a[i].filename=w[i].replace(/^\d+_\d{13}_/,"");a[i].isImage=/image./.test(n[i].type);r(w[i],a[i].url,true)}}e.render(u);f.focus();u.find('[data-action="post"]').prop("disabled",false);$(window).trigger("action:composer.upload",{post_uuid:s,files:a})},complete:function(){m[0].reset();a.inProgress[s].pop()}});return false});m.submit()}function c(e,r){var t=e.responseJSON&&(e.responseJSON.error||e.responseJSON.status&&e.responseJSON.status.message)||"[[error:parse-error]]";if(e&&e.status===413){t=e.statusText||"Request Entity Too Large"}app.alertError(t);$(window).trigger("action:composer.uploadError",{post_uuid:r,message:t});return t}return a});
//# sourceMappingURL=uploads.js.map