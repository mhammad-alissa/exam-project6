"use strict";define("composer/drafts",["api"],function(t){var e={};var a;e.init=function(t,r){var o=t.find(".draft-icon");function s(){i();a=setTimeout(function(){n(t,o,r)},1e3)}t.on("keyup","textarea, input.handle, input.title",s);t.on("click",'input[type="checkbox"]',s);t.on("thumb.uploaded",s);o.on("animationend",function(){$(this).toggleClass("active",false)});$(window).on("unload",function(){var t=[];try{t=localStorage.getItem("drafts:open");t=JSON.parse(t)||[]}catch(e){console.warn("[composer/drafts] Could not read list of open/available drafts");t=[]}if(t.length){t.forEach(function(t){e.updateVisibility("open",t)})}});e.migrateGuest();e.migrateThumbs(...arguments)};function i(){if(a){clearTimeout(a);a=0}}e.getDraft=function(t){console.warn("[composer/drafts] drafts.getDraft is deprecated! Use drafts.get() instead.");return localStorage.getItem(t)};function r(t){return parseInt(t,10)>0?localStorage:sessionStorage}e.get=function(t){var e=t.split(":")[1];var a=r(e);var i={text:a.getItem(t)};["cid","title","tags","uuid"].forEach(function(e){const r=a.getItem(t+":"+e);if(r){i[e]=r}});if(!parseInt(e,10)){i.handle=a.getItem(t+":handle")}$(window).trigger("action:composer.drafts.get",{save_id:t,draft:i,storage:a});return i};function n(t,a,i){if(o(app.user.uid?"localStorage":"sessionStorage")&&i&&i.save_id&&t.length){const o=t.find("input.title");const u=o&&o.val();var n=t.find("textarea").val();var s=r(app.user.uid);if(i.hasOwnProperty("cid")&&!i.save_id.endsWith(":cid:"+i.cid)){e.removeDraft(i.save_id);i.save_id=i.save_id.replace(/cid:\d+$/,"cid:"+i.cid)}if(n.length||u&&u.length){s.setItem(i.save_id,n);s.setItem(`${i.save_id}:uuid`,t.attr("data-uuid"));if(i.hasOwnProperty("cid")){const e=t.find("input.tags").val();s.setItem(i.save_id+":tags",e);s.setItem(i.save_id+":title",u)}if(!app.user.uid){var d=t.find("input.handle").val();s.setItem(i.save_id+":handle",d)}$(window).trigger("action:composer.drafts.save",{storage:s,postData:i,postContainer:t});a.toggleClass("active",true)}else{e.removeDraft(i.save_id)}}}e.removeDraft=function(t){if(!t){return}i();e.updateVisibility("available",t);e.updateVisibility("open",t);var a=t.split(":")[1];var n=r(a);const o=Object.keys(n).filter(e=>e.startsWith(t));o.forEach(t=>n.removeItem(t))};e.updateVisibility=function(t,e,a){if(!o(app.user.uid?"localStorage":"sessionStorage")||!e){return}var i=[];try{i=localStorage.getItem("drafts:"+t);i=i?JSON.parse(i):[]}catch(t){console.warn("[composer/drafts] Could not read list of open drafts");i=[]}var r=i.indexOf(e);if(a&&r===-1){i.push(e)}else if(!a&&r!==-1){i.splice(r,1)}localStorage.setItem("drafts:"+t,JSON.stringify(i))};e.migrateGuest=function(){if(o("localStorage")&&app.user.uid){var t=/^composer:\d+:\w+:\d+(:\w+)?$/;var a=Object.keys(sessionStorage).filter(function(e){return t.test(e)});var i=new Set([]);var r=a.map(function(t){var e=t.split(":");e[1]=app.user.uid;i.add(e.slice(0,4).join(":"));return e.join(":")});a.forEach(function(t,e){localStorage.setItem(r[e],sessionStorage.getItem(t));sessionStorage.removeItem(t)});i.forEach(function(t){e.updateVisibility("available",t,1)});return i}};e.migrateThumbs=function(a,i){const r=a.attr("data-uuid");const n=e.get(i.save_id);if(n&&n.uuid){t.put(`/topics/${n.uuid}/thumbs`,{tid:r}).then(()=>{require(["composer"],function(t){t.updateThumbCount(r,a)})})}};e.loadOpen=function(){if(ajaxify.data.template.login||ajaxify.data.template.register){return}var t;var a=[];try{t=localStorage.getItem("drafts:available");a=localStorage.getItem("drafts:open");t=JSON.parse(t)||[];a=JSON.parse(a)||[]}catch(e){console.warn("[composer/drafts] Could not read list of open/available drafts");t=[];a=[]}if(t.length&&app.user&&app.user.uid!==0){t.forEach(function(t){if(!t){return}var i=t.split(":");var r=i[1];var n=i[2];var o=i[3];var s=e.get(t);if(a.indexOf(t)!==-1){return}if(parseInt(app.user.uid,10)!==parseInt(r,10)){return}if(!s||s.text&&s.title&&!s.text.title&&!s.text.length){e.updateVisibility("available",t);e.updateVisibility("open",t);return}require(["composer"],function(t){if(n==="cid"){t.newTopic({cid:o,title:s.title,body:s.text,tags:[]})}else if(n==="tid"){socket.emit("topics.getTopic",o,function(e,a){if(e){return app.alertError(e.message)}t.newReply(o,undefined,a.title,s.text)})}else if(n==="pid"){t.editPost(o)}})})}};function o(t){var e;try{e=window[t];var a="__storage_test__";e.setItem(a,a);e.removeItem(a);return true}catch(t){return t instanceof DOMException&&(t.code===22||t.code===1014||t.name==="QuotaExceededError"||t.name==="NS_ERROR_DOM_QUOTA_REACHED")&&(e&&e.length!==0)}}return e});
//# sourceMappingURL=drafts.js.map