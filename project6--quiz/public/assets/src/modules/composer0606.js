"use strict";define("composer",["taskbar","translator","composer/uploads","composer/formatting","composer/drafts","composer/tags","composer/categoryList","composer/preview","composer/resize","composer/autocomplete","composer/scheduler","scrollStop","topicThumbs","api","bootbox","hooks","messages","search"],function(t,e,i,o,a,n,r,s,c,d,p,l,u,m,f,g,v,h){var b={active:undefined,posts:{},bsEnvironment:undefined,formatting:undefined};$(window).off("resize",w).on("resize",w);w();$(window).on("action:composer.topics.post",function(t,e){localStorage.removeItem("category:"+e.data.cid+":bookmark");localStorage.removeItem("category:"+e.data.cid+":bookmark:clicked")});$(window).on("popstate",function(){var t=utils.findBootstrapEnvironment();if(b.active&&(t==="xs"||t==="sm")){if(!b.posts[b.active].modified){b.discard(b.active);if(b.discardConfirm&&b.discardConfirm.length){b.discardConfirm.modal("hide");delete b.discardConfirm}return}e.translate("[[modules:composer.discard]]",function(t){b.discardConfirm=f.confirm(t,function(t){if(t){b.discard(b.active)}else{b.posts[b.active].modified=true}});b.posts[b.active].modified=false})}});function y(){var t=b.bsEnvironment;if(ajaxify.data.template.compose===true||t==="xs"||t==="sm"){history.back()}}function w(){var t=utils.findBootstrapEnvironment();var e=t==="xs"||t==="sm";if(s.toggle){if(s.env!==t&&e){s.env=t;s.toggle(false)}s.env=t}if(b.active!==undefined){c.reposition($('.composer[data-uuid="'+b.active+'"]'));if(!e&&window.location.pathname.startsWith(config.relative_path+"/compose")){history.back()}else if(e&&!window.location.pathname.startsWith(config.relative_path+"/compose")){T()}}b.bsEnvironment=t}function x(t){var e;var i;if(t.hasOwnProperty("cid")){e="cid"}else if(t.hasOwnProperty("tid")){e="tid"}else if(t.hasOwnProperty("pid")){e="pid"}i=t[e];for(var o in b.posts){if(b.posts[o].hasOwnProperty(e)&&i===b.posts[o][e]){return o}}return false}function _(i){var o=utils.generateUUID();var a=x(i);if(a){t.updateActive(a);return b.load(a)}var n="[[topic:composer.new_topic]]";if(i.action==="posts.reply"){n="[[topic:composer.replying_to]]"}else if(i.action==="posts.edit"){n="[[topic:composer.editing]]"}e.translate(n,function(e){t.push("composer",o,{title:e.replace("%1",'"'+i.title+'"')})});if(i.hasOwnProperty("cid")){i.save_id=["composer",app.user.uid,"cid",i.cid].join(":")}else if(i.hasOwnProperty("tid")){i.save_id=["composer",app.user.uid,"tid",i.tid].join(":")}else if(i.hasOwnProperty("pid")){i.save_id=["composer",app.user.uid,"pid",i.pid].join(":")}b.posts[o]=i;b.load(o)}async function E(t,e){$('.composer[data-uuid="'+t+'"]').find(".composer-submit").removeAttr("disabled");const{showAlert:i}=await g.fire("filter:composer.error",{post_uuid:t,message:e,showAlert:true});if(i){app.alert({type:"danger",timeout:3e3,title:"",message:e,alert_id:"post_error"})}}b.findByTid=function(t){for(var e in b.posts){if(b.posts.hasOwnProperty(e)&&b.posts[e].hasOwnProperty("tid")&&parseInt(b.posts[e].tid,10)===parseInt(t,10)){return e}}return null};b.addButton=function(t,e,i){o.addButton(t,e,i)};b.newTopic=function(t){var e={action:"topics.post",cid:t.cid,title:t.title||"",body:t.body||"",tags:t.tags||[],modified:!!(t.title&&t.title.length||t.body&&t.body.length),isMain:true};$(window).trigger("filter:composer.topic.push",{data:t,pushData:e});_(e)};b.addQuote=function(t,i,o,a,n,r,c){c=c||b.active;var d=(a||"").replace(/([\\`*_{}[\]()#+\-.!])/g,"\\$1").replace(/\[/g,"&#91;").replace(/\]/g,"&#93;").replace(/%/g,"&#37;").replace(/,/g,"&#44;");if(r){r="> "+r.replace(/\n/g,"\n> ")+"\n\n"}var p="["+d+"]("+config.relative_path+"/post/"+(o||i)+")";if(c===undefined){if(a&&(o||i)){b.newReply(t,i,a,"[[modules:composer.user_said_in, "+n+", "+p+"]]\n"+r)}else{b.newReply(t,i,a,"[[modules:composer.user_said, "+n+"]]\n"+r)}return}else if(c!==b.active){b.load(c)}var l=$('.composer[data-uuid="'+c+'"]');var u=l.find("textarea");var m=u.val();if(a&&(o||i)){e.translate("[[modules:composer.user_said_in, "+n+", "+p+"]]\n",config.defaultLang,f)}else{e.translate("[[modules:composer.user_said, "+n+"]]\n",config.defaultLang,f)}function f(t){b.posts[c].body=(m.length?m+"\n\n":"")+t+r;u.val(b.posts[c].body);z(l);s.render(l)}};b.newReply=function(t,i,o,a){e.translate(a,config.defaultLang,function(e){_({action:"posts.reply",tid:t,toPid:i,title:o,body:e,modified:!!(o&&o.length||e&&e.length),isMain:false})})};b.editPost=function(t){socket.emit("plugins.composer.push",t,function(e,i){if(e){return app.alertError(e.message)}i.action="posts.edit";i.pid=t;i.modified=false;_(i)})};b.load=function(t){var e=$('.composer[data-uuid="'+t+'"]');if(e.length){D(t);c.reposition(e);z(e);O()}else if(b.formatting){L(t)}else{socket.emit("plugins.composer.getFormattingOptions",function(e,i){if(e){return app.alertError(e)}b.formatting=i;L(t)})}};b.enhance=function(t,c,l){if(!c&&!l){c=utils.generateUUID();b.posts[c]=ajaxify.data;l=ajaxify.data;t.attr("data-uuid",c)}var u=t.find("input.title");var m=t.find("input.handle");var v=t.find("input.tags");var h=t.find("textarea");var w=t.find(".composer-submit");r.init(t,b.posts[c]);p.init(t,b.posts);o.addHandler(t);o.addComposerButtons();s.handleToggler(t);i.initialize(c);n.init(t,b.posts[c]);d.init(t,c);t.on("change","input, textarea",function(){b.posts[c].modified=true;a.updateVisibility("available",b.posts[c].save_id,true);a.updateVisibility("open",b.posts[c].save_id,true)});w.on("click",function(t){t.preventDefault();t.stopPropagation();$(this).attr("disabled",true);I(c)});require(["mousetrap"],function(e){e(t.get(0)).bind("mod+enter",function(){w.attr("disabled",true);I(c)})});t.find(".composer-discard").on("click",function(t){t.preventDefault();if(!b.posts[c].modified){b.discard(c);return y()}if(screenfull.isEnabled&&screenfull.isFullscreen){screenfull.exit()}var i=$(this).prop("disabled",true);e.translate("[[modules:composer.discard]]",function(t){f.confirm(t,function(t){if(t){b.discard(c);y()}i.prop("disabled",false)})})});t.find(".composer-minimize, .minimize .trigger").on("click",function(t){t.preventDefault();t.stopPropagation();b.minimize(c)});h.on("input propertychange",utils.debounce(function(){s.render(t)},250));h.on("scroll",function(){s.matchScroll(t)});a.init(t,l);var x=a.get(l.save_id);if(x&&x.title){u.val(x.title)}if(x&&x.handle){m.val(x.handle)}if(x&&x.tags){const t=x.tags.split(",");t.forEach(function(t){v.tagsinput("add",t)})}h.val(x.text?x.text:l.body);s.render(t,function(){s.matchScroll(t)});k(t);C(t);z(t);if(l.action==="posts.edit"){b.updateThumbCount(c,t)}if(!screenfull.isEnabled){$('[data-format="zen"]').addClass("hidden")}g.fire("action:composer.enhanced",{postContainer:t,postData:l,draft:x})};async function P(t){if(ajaxify.data.template.category){return ajaxify.data}else if(parseInt(t.cid,10)){return await m.get(`/api/category/${t.cid}`,{})}return null}async function L(i){var o=b.posts[i];var a=o?o.hasOwnProperty("cid"):false;var n=o?!!o.isMain:false;var r=o?!!o.pid:false;var s=o?parseInt(o.uid,10)===0:false;const d=o.timestamp>Date.now();var p=o.title.replace(/%/g,"&#37;").replace(/,/g,"&#44;");o.category=await P(o);const u=o.category?o.category.privileges:ajaxify.data.privileges;var m={title:p,titleLength:p.length,mobile:b.bsEnvironment==="xs"||b.bsEnvironment==="sm",resizable:true,thumb:o.thumb,isTopicOrMain:a||n,maximumTitleLength:config.maximumTitleLength,maximumPostLength:config.maximumPostLength,minimumTagLength:config.minimumTagLength,maximumTagLength:config.maximumTagLength,isTopic:a,isEditing:r,canSchedule:!!(n&&u&&(u["topics:schedule"]&&!r||d&&u.view_scheduled)),showHandleInput:config.allowGuestHandles&&(app.user.uid===0||r&&s&&app.user.isAdmin),handle:o?o.handle||"":undefined,formatting:b.formatting,tagWhitelist:o.category?o.category.tagWhitelist:ajaxify.data.tagWhitelist,privileges:app.user.privileges,selectedCategory:o.category,submitOptions:[]};if(m.mobile){T();app.toggleNavbar(false)}o.mobile=b.bsEnvironment==="xs"||b.bsEnvironment==="sm";({postData:o,createData:m}=await g.fire("filter:composer.create",{postData:o,createData:m}));app.parseAndTranslate("composer",m,function(a){if($('.composer.composer[data-uuid="'+i+'"]').length){return}a=$(a);a.find(".title").each(function(){$(this).text(e.unescape($(this).text()))});a.attr("data-uuid",i);$(document.body).append(a);var n=$(a[0]);c.reposition(n);b.enhance(n,i,o);D(i);n.on("click",function(){if(!t.isActive(i)){t.updateActive(i)}});c.handleResize(n);if(b.bsEnvironment==="xs"||b.bsEnvironment==="sm"){var r=n.find(".composer-submit");var s=n.find(".mobile-navbar .composer-submit");var d=n.find(".write");var p=d.attr("tabindex");r.removeAttr("tabindex");s.attr("tabindex",parseInt(p,10)+1);$(".category-name-container").on("click",function(){$(".category-selector").toggleClass("open")})}$(window).trigger("action:composer.loaded",{postContainer:n,post_uuid:i,composerData:b.posts[i],formatting:b.formatting});l.apply(n.find(".write"));z(n);O()})}function T(){var t="compose?p="+window.location.pathname;var e=window.location.pathname.slice(1)+window.location.search;if(e.startsWith(config.relative_path.slice(1))){e=e.slice(config.relative_path.length)}window.history.replaceState({url:null,returnPath:e},e,config.relative_path+"/"+e);window.history.pushState({url:t},t,`${config.relative_path}/${e}`)}function k(t){var e=t.find(".help");socket.emit("plugins.composer.renderHelp",function(t,i){if(!t&&i&&i.length>0){e.removeClass("hidden");e.on("click",function(){f.alert(i)})}})}function C(t){var e=t.attr("data-uuid");var i=b.posts[e]&&b.posts[e].action==="posts.edit";var o=utils.findBootstrapEnvironment();var a=o==="xs"||o==="sm";if(i||a){return}h.enableQuickSearch({searchElements:{inputEl:t.find("input.title"),resultEl:t.find(".quick-search-container")},hideOnNoMatches:true})}function D(t){if(b.active&&b.active!==t){b.minimize(b.active)}b.active=t;$(window).trigger("action:composer.activate",{post_uuid:t})}function z(t){setTimeout(function(){var e=t.find("input.title");if(e.length){e.focus()}else{t.find("textarea").focus().putCursorAtEnd()}},20)}async function I(t){var e=b.posts[t];var o=$('.composer[data-uuid="'+t+'"]');var s=o.find(".handle");var c=o.find(".title");var d=o.find("textarea");var l=o.find("input#topic-thumb-url");var u=e.hasOwnProperty("template")&&e.template.compose===true;const h=o.find(".composer-submit");c.val(c.val().trim());d.val(utils.rtrim(d.val()));if(l.length){l.val(l.val().trim())}var w=e.action;var x=(e.hasOwnProperty("cid")||parseInt(e.pid,10))&&o.find("input.title").length;var _=!x||x&&parseInt(e.cid,10);var P={post_uuid:t,postData:e,postContainer:o,titleEl:c,titleLen:c.val().length,bodyEl:d,bodyLen:d.val().length};await g.fire("filter:composer.check",P);$(window).trigger("action:composer.check",P);if(P.error){return E(t,P.error)}if(i.inProgress[t]&&i.inProgress[t].length){return E(t,"[[error:still-uploading]]")}else if(x&&P.titleLen<parseInt(config.minimumTitleLength,10)){return E(t,"[[error:title-too-short, "+config.minimumTitleLength+"]]")}else if(x&&P.titleLen>parseInt(config.maximumTitleLength,10)){return E(t,"[[error:title-too-long, "+config.maximumTitleLength+"]]")}else if(w==="topics.post"&&!_){return E(t,"[[error:category-not-selected]]")}else if(P.bodyLen<parseInt(config.minimumPostLength,10)){return E(t,"[[error:content-too-short, "+config.minimumPostLength+"]]")}else if(P.bodyLen>parseInt(config.maximumPostLength,10)){return E(t,"[[error:content-too-long, "+config.maximumPostLength+"]]")}else if(x&&!n.isEnoughTags(t)){return E(t,"[[error:not-enough-tags, "+n.minTagCount()+"]]")}else if(p.isActive()&&p.getTimestamp()<=Date.now()){return E(t,"[[error:scheduling-to-past]]")}let L={uuid:t};let T="post";let k="";if(w==="topics.post"){k="/topics";L={...L,handle:s?s.val():undefined,title:c.val(),content:d.val(),thumb:l.val()||"",cid:r.getSelectedCid(),tags:n.getTags(t),timestamp:p.getTimestamp()}}else if(w==="posts.reply"){k=`/topics/${e.tid}`;L={...L,tid:e.tid,handle:s?s.val():undefined,content:d.val(),toPid:e.toPid}}else if(w==="posts.edit"){T="put";k=`/posts/${e.pid}`;L={...L,pid:e.pid,handle:s?s.val():undefined,content:d.val(),title:c.val(),thumb:l.val()||"",tags:n.getTags(t),timestamp:p.getTimestamp()}}var C={composerEl:o,action:w,composerData:L,postData:e,redirect:true};await g.fire("filter:composer.submit",C);g.fire("action:composer.submit",Object.freeze(C));var D=$('#taskbar .composer[data-uuid="'+t+'"] i');var z=o.find(".write");D.removeClass("fa-plus").addClass("fa-circle-o-notch fa-spin");b.minimize(t);z.prop("readonly",true);m[T](k,L).then(i=>{h.removeAttr("disabled");e.submitted=true;b.discard(t);a.removeDraft(e.save_id);if(i.queued){f.alert(i.message)}else if(w==="topics.post"){if(C.redirect){ajaxify.go("topic/"+i.slug,undefined,u||b.bsEnvironment==="xs"||b.bsEnvironment==="sm")}}else if(w==="posts.reply"){if(u||b.bsEnvironment==="xs"||b.bsEnvironment==="sm"){window.history.back()}else if(C.redirect&&(ajaxify.data.template.name!=="topic"||ajaxify.data.template.topic&&parseInt(e.tid,10)!==parseInt(ajaxify.data.tid,10))){ajaxify.go("post/"+i.pid)}}else{y()}$(window).trigger("action:composer."+w,{composerData:L,data:i})}).catch(e=>{b.load(t);z.prop("readonly",false);if(e.message==="[[error:email-not-confirmed]]"){return v.showEmailConfirmWarning(e.message)}E(t,e.message)})}function O(){$("html").addClass("composing")}function j(){$("body").css({paddingBottom:0});$("html").removeClass("composing");app.toggleNavbar(true)}b.discard=function(e){if(b.posts[e]){var i=b.posts[e];var o=$('.composer[data-uuid="'+e+'"]');o.remove();a.removeDraft(i.save_id);u.deleteAll(e);t.discard("composer",e);$('[data-action="post"]').removeAttr("disabled");g.fire("action:composer.discard",{post_uuid:e,postData:i});delete b.posts[e];b.active=undefined}p.reset();j()};b.close=b.discard;b.minimize=function(e){var i=$('.composer[data-uuid="'+e+'"]');i.css("visibility","hidden");b.active=undefined;t.minimize("composer",e);$(window).trigger("action:composer.minimize",{post_uuid:e});j()};b.minimizeActive=function(){if(b.active){b.miminize(b.active)}};b.updateThumbCount=function(t,e){const i=b.posts[t];if(i.action==="topics.post"||i.action==="posts.edit"&&i.isMain){const o=[u.get(t)];if(i.pid){o.push(u.getByPid(i.pid))}Promise.all(o).then(t=>{t=t.reduce((t,e)=>{t=t.concat(e);return t});if(t.length){const i=e.find('[data-format="thumbs"]');i.attr("data-count",t.length)}})}};return b});
//# sourceMappingURL=composer.js.map